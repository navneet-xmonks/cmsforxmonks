<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xMonks Blog CMS - Create New Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --xmonks-primary: #2c3e50;
            --xmonks-secondary: #3498db;
            --xmonks-accent: #e74c3c;
            --xmonks-success: #27ae60;
            --xmonks-warning: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }
        
        .cms-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .cms-header {
            background: linear-gradient(135deg, var(--xmonks-primary) 0%, var(--xmonks-secondary) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .cms-header h1 {
            margin: 0;
            font-weight: 600;
            font-size: 2.5rem;
        }
        
        .cms-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .cms-body {
            padding: 40px;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid var(--xmonks-secondary);
        }
        
        .form-section h3 {
            color: var(--xmonks-primary);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--xmonks-secondary);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--xmonks-secondary) 0%, var(--xmonks-primary) 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: var(--xmonks-success);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
        }
        
        .btn-danger {
            background: var(--xmonks-accent);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
        }
        
        .section-item, .faq-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .section-item:hover, .faq-item:hover {
            border-color: var(--xmonks-secondary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .subsection-item {
            background: #f1f3f4;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            margin-left: 20px;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--xmonks-secondary) 0%, var(--xmonks-primary) 100%);
        }
        
        .alert-info {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid var(--xmonks-success);
            color: #155724;
        }
        
        .preview-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .result-section {
            display: none;
            margin-top: 20px;
        }
        
        .icon-badge {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="cms-container">
        <div class="cms-header">
            <h1><i class="fas fa-blog"></i> xMonks Blog CMS</h1>
            <p>Create engaging blog posts with structured content, FAQs, and multimedia</p>
        </div>
        
        <div class="cms-body">
                        <form id="blogForm" class="needs-validation" enctype="multipart/form-data" novalidate>
                <!-- Basic Information -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle icon-badge"></i> Basic Information</h3>
                    <div class="row">
                        <div class="col-md-8">
                            <label for="title" class="form-label">Blog Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="Enter an engaging blog title">
                        </div>
                        <div class="col-md-4">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Choose category...</option>
                                <option value="Leadership">Leadership</option>
                                <option value="Wellness">Wellness</option>
                                <option value="Self Development">Self Development</option>
                                <option value="Entrepreneurship">Entrepreneurship</option>
                                <option value="Spirituality">Spirituality</option>
                                <option value="Social Issues">Social Issues</option>
                                <option value="Sports">Sports</option>
                                <option value="Technology">Technology</option>
                                <option value="Personal Growth">Personal Growth</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="author" class="form-label">Author</label>
                            <input type="text" class="form-control" id="author" name="author" 
                                   value="xmonks" placeholder="Author name">
                        </div>
                        <div class="col-md-4">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date">
                        </div>
                        <div class="col-md-4">
                            <label for="videoUrl" class="form-label">YouTube Video URL</label>
                            <input type="url" class="form-control" id="videoUrl" name="videoUrl" 
                                   placeholder="https://www.youtube.com/embed/...">
                        </div>
                    </div>
                </div>

                <!-- JSON-LD Schema -->
                <div class="form-section">
                    <h3><i class="fas fa-code icon-badge"></i> JSON-LD Schema</h3>
                    <div class="mb-3">
                        <label for="jsonLD" class="form-label">Custom JSON-LD (Optional)</label>
                        <textarea class="form-control" id="jsonLD" name="jsonLD" rows="8" 
                                  placeholder='Paste your custom JSON-LD here (without script tags):
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [...]
}'></textarea>
                        <div class="form-text">Paste custom JSON-LD content here. Will be wrapped in script tags automatically.</div>
                    </div>
                </div>

                <!-- Image Information -->
                <div class="form-section">
                    <h3><i class="fas fa-image icon-badge"></i> Blog Images</h3>
                    
                    <!-- Feature Image (for blogs.json) -->
                    <div class="mb-4">
                        <h5 class="text-primary"><i class="fas fa-star"></i> Feature Image (for blog listing)</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="featureImageFile" class="form-label">Upload Feature Image</label>
                                <input type="file" class="form-control" id="featureImageFile" name="featureImageFile" 
                                       accept="image/*" onchange="updateImageName(this, 'featureImageName')">
                                <div class="form-text">Upload image file</div>
                            </div>
                            <div class="col-md-4">
                                <label for="featureImageName" class="form-label">Image Filename</label>
                                <input type="text" class="form-control" id="featureImageName" name="featureImageName" 
                                       placeholder="feature-image.jpg" readonly>
                                <div class="form-text">Auto-filled from upload</div>
                            </div>
                            <div class="col-md-4">
                                <label for="featureImageAlt" class="form-label">Feature Image Alt Text</label>
                                <input type="text" class="form-control" id="featureImageAlt" name="featureImageAlt" 
                                       placeholder="Alt text for feature image">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Blog Content Image -->
                    <div class="mb-3">
                        <h5 class="text-secondary"><i class="fas fa-file-image"></i> Blog Content Image (appears in article)</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="contentImageFile" class="form-label">Upload Content Image</label>
                                <input type="file" class="form-control" id="contentImageFile" name="contentImageFile" 
                                       accept="image/*" onchange="updateImageName(this, 'contentImageName')">
                                <div class="form-text">Upload image file</div>
                            </div>
                            <div class="col-md-4">
                                <label for="contentImageName" class="form-label">Image Filename</label>
                                <input type="text" class="form-control" id="contentImageName" name="contentImageName" 
                                       placeholder="content-image.jpg" readonly>
                                <div class="form-text">Auto-filled from upload</div>
                            </div>
                            <div class="col-md-4">
                                <label for="contentImageAlt" class="form-label">Content Image Alt Text</label>
                                <input type="text" class="form-control" id="contentImageAlt" name="contentImageAlt" 
                                       placeholder="Alt text for content image">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Image Path:</strong> All images will be saved to <code>./imagesofblog/</code>
                    </div>
                </div>

                <!-- Sections -->
                <div class="form-section">
                    <h3><i class="fas fa-list icon-badge"></i> Blog Sections</h3>
                    <div id="sectionsContainer">
                        <!-- Sections will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-success" onclick="addSection()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                </div>

                <!-- FAQs -->
                <div class="form-section">
                    <h3><i class="fas fa-question-circle icon-badge"></i> Frequently Asked Questions</h3>
                    <div id="faqsContainer">
                        <!-- FAQs will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-success" onclick="addFAQ()">
                        <i class="fas fa-plus"></i> Add FAQ
                    </button>
                </div>

                <!-- Submit -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-rocket"></i> Create Blog Post
                    </button>
                </div>
            </form>

            <!-- Loading -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Creating blog...</span>
                </div>
                <p class="mt-3">Creating your blog post...</p>
            </div>

            <!-- Results -->
            <div class="result-section" id="resultSection">
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading"><i class="fas fa-check-circle"></i> Success!</h4>
                    <p id="resultMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sectionCount = 0;
        let faqCount = 0;

        // Set today's date as default
        document.getElementById('date').value = new Date().toISOString().split('T')[0];

        function addSection() {
            sectionCount++;
            const container = document.getElementById('sectionsContainer');
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section-item';
            sectionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-file-alt"></i> Section ${sectionCount}</h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSection(this)">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Section Title *</label>
                    <input type="text" class="form-control section-title" name="sectionTitle[]" required>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" onchange="toggleSubsections(this)">
                        <label class="form-check-label">This section has subsections</label>
                    </div>
                </div>
                <div class="section-content">
                    <label class="form-label">Section Content</label>
                    <textarea class="form-control" name="sectionContent[]" rows="4" 
                              placeholder="Enter the main content for this section"></textarea>
                </div>
                <div class="subsections-container" style="display: none;">
                    <h6 class="mt-3 mb-2">Subsections:</h6>
                    <div class="subsections-list"></div>
                    <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addSubsection(this)">
                        <i class="fas fa-plus"></i> Add Subsection
                    </button>
                </div>
            `;
            container.appendChild(sectionDiv);
        }

        function removeSection(button) {
            button.closest('.section-item').remove();
        }

        function toggleSubsections(checkbox) {
            const container = checkbox.closest('.section-item').querySelector('.subsections-container');
            const contentDiv = checkbox.closest('.section-item').querySelector('.section-content');
            
            if (checkbox.checked) {
                container.style.display = 'block';
                contentDiv.style.display = 'none';
            } else {
                container.style.display = 'none';
                contentDiv.style.display = 'block';
                // Clear subsections
                container.querySelector('.subsections-list').innerHTML = '';
            }
        }

        function addSubsection(button) {
            const subsectionsList = button.parentElement.querySelector('.subsections-list');
            const subsectionDiv = document.createElement('div');
            subsectionDiv.className = 'subsection-item';
            subsectionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Subsection</strong>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSubsection(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="form-label">Subsection Title</label>
                    <input type="text" class="form-control subsection-title" name="subsectionTitle[]">
                </div>
                <div class="mb-2">
                    <label class="form-label">Subsection Content</label>
                    <textarea class="form-control subsection-content" name="subsectionContent[]" rows="3"></textarea>
                </div>
            `;
            subsectionsList.appendChild(subsectionDiv);
        }

        function removeSubsection(button) {
            button.closest('.subsection-item').remove();
        }

        function addFAQ() {
            faqCount++;
            const container = document.getElementById('faqsContainer');
            const faqDiv = document.createElement('div');
            faqDiv.className = 'faq-item';
            faqDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-question"></i> FAQ ${faqCount}</h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeFAQ(this)">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Question *</label>
                    <input type="text" class="form-control faq-question" name="faqQuestion[]" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Answer *</label>
                    <textarea class="form-control faq-answer" name="faqAnswer[]" rows="3" required></textarea>
                </div>
            `;
            container.appendChild(faqDiv);
        }

        function removeFAQ(button) {
            button.closest('.faq-item').remove();
        }

        // Update image name when file is selected
        function updateImageName(fileInput, nameInputId) {
            const nameInput = document.getElementById(nameInputId);
            if (fileInput.files && fileInput.files[0]) {
                nameInput.value = fileInput.files[0].name;
            }
        }

        // Add initial section and FAQ
        addSection();
        addFAQ();

        // Form submission
        document.getElementById('blogForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Check if we have image files to upload
            const featureImageFile = formData.get('featureImageFile');
            const contentImageFile = formData.get('contentImageFile');
            
            const blogData = {
                title: formData.get('title'),
                category: formData.get('category'),
                author: formData.get('author') || 'xmonks',
                date: formData.get('date'),
                videoUrl: formData.get('videoUrl'),
                customJsonLD: formData.get('jsonLD'),
                featureImage: {
                    name: formData.get('featureImageName'),
                    alt: formData.get('featureImageAlt') || formData.get('title'),
                    file: featureImageFile
                },
                contentImage: {
                    name: formData.get('contentImageName'),
                    alt: formData.get('contentImageAlt') || 'Blog content image',
                    file: contentImageFile
                },
                sections: [],
                faqs: []
            };

            // Collect sections
            const sectionItems = document.querySelectorAll('.section-item');
            sectionItems.forEach(item => {
                const title = item.querySelector('.section-title').value;
                if (!title) return;

                const section = { title };
                const hasSubsections = item.querySelector('.form-check-input').checked;
                
                if (hasSubsections) {
                    section.subsections = [];
                    const subsectionItems = item.querySelectorAll('.subsection-item');
                    subsectionItems.forEach(subItem => {
                        const subTitle = subItem.querySelector('.subsection-title').value;
                        const subContent = subItem.querySelector('.subsection-content').value;
                        if (subTitle && subContent) {
                            section.subsections.push({ title: subTitle, content: subContent });
                        }
                    });
                } else {
                    section.content = item.querySelector('textarea[name="sectionContent[]"]').value;
                }
                
                blogData.sections.push(section);
            });

            // Collect FAQs
            const faqItems = document.querySelectorAll('.faq-item');
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question').value;
                const answer = item.querySelector('.faq-answer').value;
                if (question && answer) {
                    blogData.faqs.push({ question, answer });
                }
            });

            // Show loading
            document.getElementById('blogForm').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'block';

            try {
                // Create FormData to handle file uploads
                const formData = new FormData();
                
                // Basic fields
                formData.append('title', blogData.title);
                formData.append('category', blogData.category);
                formData.append('author', blogData.author);
                formData.append('date', blogData.date);
                formData.append('videoUrl', blogData.videoUrl);
                formData.append('jsonLD', blogData.customJsonLD || '');
                
                // Image files
                const featureImageFile = document.getElementById('featureImageFile').files[0];
                const contentImageFile = document.getElementById('contentImageFile').files[0];
                
                if (featureImageFile) {
                    formData.append('featureImageFile', featureImageFile);
                }
                if (contentImageFile) {
                    formData.append('contentImageFile', contentImageFile);
                }
                
                // Image names and alts
                formData.append('featureImageName', blogData.featureImage.name);
                formData.append('featureImageAlt', blogData.featureImage.alt);
                formData.append('contentImageName', blogData.contentImage.name);
                formData.append('contentImageAlt', blogData.contentImage.alt);
                
                // Sections
                blogData.sections.forEach((section, index) => {
                    formData.append(`sections[${index}][title]`, section.title);
                    if (section.content) {
                        formData.append(`sections[${index}][content]`, section.content);
                    }
                    if (section.subsections) {
                        section.subsections.forEach((sub, subIndex) => {
                            formData.append(`sections[${index}][subsections][${subIndex}][title]`, sub.title);
                            formData.append(`sections[${index}][subsections][${subIndex}][content]`, sub.content);
                        });
                    }
                });
                
                // FAQs
                blogData.faqs.forEach((faq, index) => {
                    formData.append(`faqs[${index}][question]`, faq.question);
                    formData.append(`faqs[${index}][answer]`, faq.answer);
                });

                const response = await fetch('/api/create-blog', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // Hide loading
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (result.success) {
                    document.getElementById('resultMessage').innerHTML = `
                        <strong>Blog created successfully!</strong><br>
                        📁 HTML file: ${result.filePath}<br>
                        🔗 Link: ${result.link}<br>
                        🖼️ Don't forget to add your image to: ./imagesofblog/${blogData.imageInfo.name}
                    `;
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('resultSection').querySelector('.alert').className = 'alert alert-success';
                } else {
                    document.getElementById('resultMessage').innerHTML = `
                        <strong>Error creating blog:</strong><br>
                        ${result.error}
                    `;
                    document.getElementById('resultSection').style.display = 'block';
                    document.getElementById('resultSection').querySelector('.alert').className = 'alert alert-danger';
                    document.getElementById('blogForm').style.display = 'block';
                }
            } catch (error) {
                // Hide loading
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('blogForm').style.display = 'block';
                
                alert('Error creating blog: ' + error.message);
            }
        });
    </script>
</body>
</html>
